# Pantheon GPU Miner Research Documentation

## Contents

<!-- TOC depthFrom:2 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [Contents](#contents)
- [1 | Current Pantheon Releases](#1-current-pantheon-releases)
- [2 | Mining Software](#2-mining-software)
	- [2.1 Qtminer](#21-qtminer)
	- [2.2 Minergate](#22-minergate)
	- [2.3 Claymore](#23-claymore)
	- [2.4 Phoenix Miner](#24-phoenix-miner)
	- [2.5 Ethminer](#25-ethminer)
- [3 | API protocols](#3-api-protocols)
  - [3.1 Getwork Protocol](#31-getwork-protocol)
	- [3.2 Stratum Protocol](#32-stratum-protocol)
- [References](#references)

<!-- /TOC -->

## 1 | Current Pantheon Releases

Pantheon, as of now, is a Command Line Interface (CLI) solution, and such, design a user interface is not within the scope of the project. However, as a CLI application, flags must be included to perform various operations.


Pantheon's current mining solution uses CPU mining. From [Pantheon's documentation](https://docs.pantheon.pegasys.tech/en/latest/Getting-Started/Starting-Pantheon/), the following instructions are supplied which include mining:

> To run a node that mines blocks at a rate suitable for testing purposes:

```
pantheon --network=dev --miner-enabled --miner-coinbase=0xfe3b557e8fb62b89f4916b721be55ceb828dbd73 --rpc-http-cors-origins="all" --host-whitelist="*" --rpc-ws-enabled --rpc-http-enabled --data-path=/tmp/tmpDatdir
```

>Alternatively, use the following configuration file on the command line to start a node with the same options as above:
>
```
network="dev"
miner-enabled=true`
miner-coinbase="0xfe3b557e8fb62b89f4916b721be55ceb828dbd73"
rpc-http-cors-origins=["all"]
host-whitelist=["*"]
rpc-ws-enabled=true
rpc-http-enabled=true
data-path="/tmp/tmpdata-path"
```


Currently, Pantheon [offers binaries](https://docs.pantheon.pegasys.tech/en/latest/Installation/Install-Binaries/) for Windows, MacOS, and Linux. As such, it would be ideal for a GPU miner integration to include compatibility across these three operating systems.

Several MacOS hardware offerings may be insufficient for hardware mining, as many models come with integrated graphics.

The Mac current offerings in Apple.com show [the following graphics options](https://www.apple.com/mac/compare/):

- Mac Mini: Intel UHD Graphics 630
- Macbook Air (Retina): Intel UHD Graphics 617
- Macbook Pro (13 in): Intel Iris Plus Graphics 645 or 655
- Macbook Pro (15 in):
  - Intel UHD Graphics 630 (all configurations)
  - Radeon Pro 555X with 4GB of GDDR5 memory
  - Radeon Pro 560X with 4GB of GDDR5 memory
  - Radeon Pro Vega 16 with 4GB of HBM2 memory
  - Radeon Pro Vega 20 with 4GB of HBM2 memory
- iMac (21.5 in): Intel Iris Plus Graphics 640
- iMac (21.5 in Retina):
  - Radeon Pro 555X with 2GB of GDDR5 memory
  - Radeon Pro 560X with 4GB of GDDR5 memory
  - Radeon Pro Vega 20 with 4GB of HBM2 memory
- iMac (25 in):
  - Radeon Pro 570X with 4GB of GDDR5 memory
  - Radeon Pro 575X with 4GB of GDDR5 memory
  - Radeon Pro 580X with 8GB of GDDR5 memory
  - Radeon Pro Vega 48 with 8GB of HBM2 memory
- iMac Pro:
  - Radeon Pro Vega 56 with 8GB of HBM2 memory
  - Radeon Pro Vega 64 with 16GB of HBM2 memory
  - Radeon Pro Vega 64X with 16GB of HBM2 memory
- Mac Pro:
  - Dual AMD FirePro D500 with 3GB of GDDR5 memory each
  - Dual AMD FirePro D700 with 6GB of GDDR5 memory each
- Mac Pro (New):
  - One Radeon Pro 580X MPX Module with 8GB of GDDR5 memory
  - One or two Radeon Pro Vega II MPX Modules with 32GB of HBM2 memory each
  - One or two Radeon Pro Vega II Duo MPX Modules with 64GB of HBM2 memory each

_Note that the Radeon Pro 580X MPX [is a less powerful model](https://www.techpowerup.com/gpu-specs/radeon-pro-580x.c3398) than the Radeon Rx 580._

Due to increases in DAG file, it's no longer possible to GPU mine with 2GB memory graphics cards. Any Mac with 2GB of GPU memory will be unable to mine.

Mining on Intel integrated graphics cards (iGPUs) [have had reports of](https://bitcointalk.org/index.php?topic=1820187.0) very low hashing power along with possibly permamently damaging the iGPU.

Mining on Macbook Pro GPUs have [had reported hashing rates of 8 Mh/s](https://forum.ethereum.org/discussion/16483/mining-on-the-macbook-pros-amd-radeon-560-gpu). However, mining on Macbooks is not recommended due to how Macbooks handle heat, and the amount of heat generated by mining.

Certain models of the iMac and Mac Pro are sufficent to mine with, namely models with Radeon Pro Vega GPUs. However, considering how expensive these higher Mac offerings can be, how these Macs handle heat should be of concern as it may be possible mining may cause permanent damage to the computer. However, Mac compatibility should be considered for these higher models.It is also possible to mine with an external graphics card(s) (eGPU) on Mac, further creating a case for compatibility.

## 2 | Mining Software


Ethereum mining software includes the following:

- [ETHminer](https://github.com/ethereum-mining/ethminer)
- [Claymore](https://github.com/Claymore-Dual/Claymore-Dual-Miner)
- [Qtminer](https://github.com/etherchain-org/qtminer)
- [Mingergate's Miner](https://minergate.com/downloads)


### 2.1 Qtminer

Qtminer's repo [describes the project as](https://github.com/etherchain-org/qtminer) a Stratum enabled Ethereum miner, however lacks sufficient documentation.

A [good number of users](https://www.reddit.com/r/EtherMining/search/?q=qtminer&restrict_sr=1)
have used Qtminer in the past, however these recorded cases exceed a year ago, while [Claymore](https://www.reddit.com/r/EtherMining/search/?q=claymore&restrict_sr=1) and [Ethminer engagements](https://www.reddit.com/r/EtherMining/search/?q=ethminer&restrict_sr=1) have been more recent.

[Qtminer's Github repo](https://github.com/etherchain-org/qtminer/commits/master) indicates only 4 commits to the project, all in the year 2015, indicating no ongoing or recent development or developer interest in the project.

This miner should not be pursued for this project.

### 2.2 Minergate

Minergate [has support for](https://minergate.com/downloads) both Windows, Linux, and MacOS. Mingergate miner is a miner [built for the MinerGate mining pool](https://minergate.com/). Minergate's website promises hashing speeds slightly more optimized than those from Ethminer and Claymore, displaying hashing power of [14.39 Mh/s, vs 14.13 and 14.31 Mh/s](https://minergate.com/downloads) for Claymore and Ethminer respectively for an AMD Rx580 GPU.

However, Minergate is a GUI program, which may excessive as Pantheon is a Command Line Interface application. Minergate will also not be considered.


### 2.3 Claymore

Of the mining programs most actively used by miners currently, both Claymore and Ethminer seem to be [the most broadly used](https://www.reddit.com/r/EtherMining).

Claymore [supports both](https://github.com/Claymore-Dual/Claymore-Dual-Miner) NVIDIA and AMD GPUs, optimized for OpenCL and CUDA cores.

Claymore charges a [1% developer fee](https://github.com/Claymore-Dual/Claymore-Dual-Miner) for ETH mining, which [reportedly increases](https://www.reddit.com/r/EtherMining/wiki/software/apps) with dual mining other currencies.

Claymore does not seem to be have any software license.

### 2.4 Phoenix Miner

[Phoenix Miner](https://github.com/Phoenix-Miner/PhoenixMiner), like Claymore, is a miner optimized for OpenCL and CUDA cores. Phoenix Miner also contains a 1% developer fee. This fee is collected by mining with the developer's address [for 35 seconds every 90 minutes](https://github.com/Phoenix-Miner/PhoenixMiner), similar to Claymore. During its initial release, Phoenix seemed to do[ slightly better than Claymore in hashrate optimization](https://www.reddit.com/r/EtherMining/comments/7t2sd6/anyone_try_phoenix_miner_apparently_slightly/).


Phoenix Miner does not seem to be have any software license.

### 2.5 Ethminer

[Ethminer](https://github.com/ethereum-mining/ethminer) originates from `cpp-ethereum` which became [Aleth](https://github.com/ethereum/aleth), a C++ Ethereum client. Ethminer started after `cpp-ethereum` discontinued its GPU mining functionality.

Ethminer [supports both](https://github.com/ethereum-mining/ethminer) NVIDIA and AMD GPUs (OpenCL and CUDA cores).

The [Minergate pool reports](https://minergate.com/downloads) slightly faster and slightly slower hashrates of Ethminer compared to Claymore depending on GPU, however, both stay relatively close in hashrates.

Ethminer has had over 14,000 commits, with the last commit [occuring late June, 2019](https://github.com/ethereum-mining/ethminer/commits/master).

Unlike Claymore and Phoenix Miner, there exists [an Ethminer version compatible with Mac](https://github.com/ArtSabintsev/Ethminer-for-macOS), The Mac Ethminer repo contains over 12,000 commits, however, the last commit was recieved in 2018.

Ethminer also [does not seem to include a dev fee](https://github.com/ethereum-mining/ethminer).

Ethminer has compatibility for Windows, Linux and [MacOS](https://github.com/ArtSabintsev/Ethminer-for-macOS).

Ethminer comes in [standalone executables](https://github.com/ethereum-mining/ethminer/releases/tag/v0.18.0) for Linux and Windows. Ethminer can also be [built from source](https://github.com/ethereum-mining/ethminer/blob/master/docs/BUILD.md).

However, Ethminer is GPL 3.0, which is compatible with Pantheon's Apache 2.0 license. However, the previous MacOS build for Ethminer is forked from `cpp-ethereum` when it was licensed GPL 2.0, which  is incompatible with Apache 2.0.

## 3 | API Protocols

From the [Ethminer documentation](https://github.com/ethereum-mining/ethminer/blob/master/docs/POOL_EXAMPLES_ETH.md), Ethminer connects to mining pools using the following syntax:

```
-P scheme://user[.workername][:password]@hostname:port[/...]
```

Where values in square brackets are optional. The value `scheme` can be any of the following:

- `http` for getwork mode (geth)
- `stratum+tcp` for plain stratum mode
- `stratum1+tcp` for plain stratum eth-proxy compatible mode
- `stratum2+tcp` for plain stratum NiceHash compatible mode

For a Pantheon node on localhost, the hostname and port would be `localhost` and, what appears to be from building from the Pantheon repository, port 30303.

### 3.1 Getwork Protocol

An overview of getwork can be [found on the Bitcoin wiki](https://en.bitcoinwiki.org/wiki/Getwork). Getwork uses JSON-RPC over an HTTP transport. Without arguments, getworkprovides a block header for a miner to find a solution.

The following is a getwork implementation example for Ethereum:

- https://github.com/sammy007/ether-proxy

### 3.2 Stratum Protocol

The following sources provide a specification for Stratum


- [EIP 1571](http://eips.ethereum.org/EIPS/eip-1571)
- [Slushpool](https://slushpool.com/help/stratum-protocol/) and [Slushpool Githbut](https://github.com/slushpool/stratumprotocol/blob/master/stratum-extensions.mediawiki)
- [Nicehash](https://github.com/nicehash/Specifications/blob/master/EthereumStratum_NiceHash_v1.0.0.txt)
- [Sia Mining](https://siamining.com/stratum)
- [Aion Network](https://github.com/aionnetwork/aion_miner/wiki/Aion-Stratum-Protocol)
- [php-proxy-stratum](https://github.com/ctubio/php-proxy-stratum/wiki/Stratum-Mining-Protocol)
- [open-ethereum-pool](https://github.com/sammy007/open-ethereum-pool/blob/master/docs/STRATUM.md)


[Originally created for](https://slushpool.com/help/stratum-protocol/) the Bitcoin client [Electrum](https://electrum.org/#home), the Stratum Protocol was ported to mining to [overcome getwork shortcomings](https://slushpool.com/help/stratum-protocol/) when considering large scale mining systems.

Getwork specification for the SHA-256 mining algorithm may be [suitable for a 4.2 GH/s mining rig](https://slushpool.com/help/stratum-protocol/). This means, for a 42 GH/s mining rig, 10 concurrent requests are required. For larger scale [ASIC](https://en.bitcoin.it/wiki/ASIC) mining equipment, this leads to not enough jobs to meet the capacity of the equipment via the getwork protocol.

With the introduction of mining pools, several mining rigs combining hasing capacity for shared mining rewards, [under getwork, miners had to choose](https://slushpool.com/help/stratum-protocol/) short intervals which led to higher network load and lower staling ratio, or intervals which do not overload the network and servers.[Long polling](https://en.bitcoin.it/wiki/Long_polling), the solution to this problem, [created another problem]() where long polling reconnections were difficult to distinguish from DDoS attacks.

While http getwork may be sufficient for lesser powered mining rigs, since Pantheon is an enterprise level solution, Stratum should be the considered implementation.


The Stratum Protocol [reduces client-server communications](https://github.com/ctubio/php-proxy-stratum/wiki/Stratum-Mining-Protocol) to work under very low bandwidth, reducing server strain. [The server pushes work](https://slushpool.com/help/stratum-protocol/) to the mining client, whereby the miner can use that work until the next push, regardless of hashing rate.

[Stratum uses](https://slushpool.com/help/stratum-protocol/) a plain TCP socket, with payload encoded as JSON-RPC messages.  [The mining client opens](https://slushpool.com/help/stratum-protocol/) a TCP socket and writes requests to the server in JSON messages finished by the newline character `\n`. [Each line received](https://slushpool.com/help/stratum-protocol/) by the client is a JSON-RPC fragment containing the response.


The following are examples of Stratum implementations for Ethereum:
- https://github.com/Atrides/eth-proxy
- https://github.com/sammy007/open-ethereum-pool
- https://github.com/coinfoundry/Miningcore
- https://bitcointalk.org/index.php?topic=1200891.0


## 4 | Stratum Implementation

## 4.1 Rationale

Ethminer offers the following options for pool connection:
- `stratum1+tcp`
- `stratum2+tcp`

`stratum1` refers to the Dwarfpool implementation of stratum, the first stratum implementation for Ethereum. The Dwarfpool stratum implementation can be found here: https://github.com/Atrides/eth-proxy.

`stratum2` refers to the Nicehash specification of stratum, "EthereumStratum/1.0.0." The Nicehash stratum specification was created to offer improvements to the Dwarfpool implementation.

An update the Nicehash stratum specification is given in [EIP 1571](http://eips.ethereum.org/EIPS/eip-1571), titled "EthereumStratum/2.0.0."

Due to the detail of the Nicehash specification, along with improvements offered by this stratum protocol, the Nicehash stratum protocol will be explored.

The [Nicehash protocol](https://github.com/nicehash/Specifications/blob/master/EthereumStratum_NiceHash_v1.0.0.txt) offers the following benefits over the Dwarfpool stratum implementation:

1. Unique data per miner/worker
2. Reduction of difficulty redundancy
3. Reduction of data redundancy
4. Increased consistency with the original [Slushpool stratum specification](https://slushpool.com/help/stratum-protocol/)
5. Documentation of specification, as opposed to pure implementation

An example implementation of the Nicehash stratum protocol can be found at [Miningcore's repo](https://github.com/coinfoundry/Miningcore).

[Nicehash stratum specification](https://github.com/nicehash/Specifications/blob/master/EthereumStratum_NiceHash_v1.0.0.txt) is as following:

### 4.2 Initial Connection

Handshake happens after TCP connection is established.

Miner sends data first:

```
{
  "id": 1,
  "method": "mining.subscribe",
  "params": [
    "MinerName/1.0.0", "EthereumStratum/1.0.0"
  ]
}\n
```
- `mining.subscribe`: Miner subscribes to work from a server, required before all other communication.
- `Parameter 1`: Miner name and version
- `Parameter 2`: Stratum protocol and version ("EthereumStratum/Version" for the Nicehash spec)

Each message from miner to pool must have a unique id for the miner to properly read responses as pool may not process miner's messages in first-in-first-out manner.

Server replies:

```
{
  "id": 1,
  "result": [
    [
      "mining.notify",
      "ae6812eb4cd7735a302a8a9dd95cf71f",
      "EthereumStratum/1.0.0"
    ],
    "080c"
  ],
  "error": null
}\n
```
- `mining.notify`: Pushes new work to the miner.
- `Parameter 2` of `result`: Extranonce (in Hex) set by pool. Extranonce may be max 3 bytes in size.
- `Parameter 3` of `result`: "EthereumStratum/1.0.0". If the pool does not report this parameter, or a different version than is supported is reported, the miner should terminate connection.


Miner shall authorize during initial handshake.

### 4.3 Difficulty

Before first job (work) is provided, pool must set difficulty:

```
{
  "id": null,
  "method": "mining.set_difficulty",
  "params": [
    0.5
  ]
}\n
```
- `mining.set_difficulty`: Signals the miner to stop submitting shares below the new difficulty.
- `Parameter 1`: Difficulty in `double` data-type. Conversion
between difficulty and target is done as with Bitcoin.
Difficulty of 1 is transformed to target in HEX:
`00000000ffff0000000000000000000000000000000000000000000000000000`.

If the pool does not set difficulty before first job, then miner assumes difficulty 1 was set.

When difficulty changes, the miner uses the new difficulty for all subsequent jobs recieved.

### 4.4 ExtraNonce

If miner has subscribed to extranonce notifications, then pool may change
miner's extranonce by sending:

```
{
  "id": null,
  "method": "mining.set_extranonce",
  "params": [
    "af4c"
  ]
}\n
```

- `mining.set_extranonce`: Miner replaces the initial subscription values starting with the next recieved job

New extranonce is valid for all subsequent jobs recieved.

### 4.5 Jobs

Pool informs miners about job (work) by sending:

```
{
  "id": null,
  "method": "mining.notify",
  "params": [
    "bf0488aa",
    "abad8f99f3918bf903c6a909d9bbc0fdfa5a2f4b9cb1196175ec825c6610126c",
    "645cf20198c2f3861e947d4f67e3ab63b7b2e24dcc9095bd9123e7b33371f6cc",
    true
  ]
}\n
```

- `mining.notify`: Pushes new work to the miner.
- `Parameter 1`: job ID (must be HEX number of any
size)
- `Parameter 2`: Seedhash. Sent with every job to support possible multipools which rapidly change currencies.
- `Parameter 3`: Headershash.
- `Parameter 4`: Boolean `cleanjobs`.  If set `true`, the miner must clear queue of jobs and immediatelly work on new provided job, as old jobs will result in stale share error.

Miner uses seedhash to identify DAG, then tries to find share below
target (which is created out of provided difficulty) with headerhash,
extranonce and own minernonce.

Share submission (completed jobs) by miner:

```
{
  "id": 244,
  "method": "mining.submit",
  "params": [
    "username",
    "bf0488aa",
    "6a909d9bbc0f"
  ]
}\n
```

- `mining.submit`: Submits shares
- `Parameter 1`: username
- `Parameter 2`: job ID
- `Parameter 3`: minernonce

In the above example minernonce is 6 bytes, because
provided extranonce was 2 bytes. If the pool provides 3 bytes extranonce,
then minernonce must be 5 bytes.

For every work submit, the pool must respond with standard stratum
response:

```
{
  "id": 244,
  "result": true,
  "error": null
}\n
```

For shares accepted.


```
{
  "id": 244,
  "result": false,
  "error": [
    -1,
    "Job not found",
    NULL
  ]
}\n

```

For shares not accepted.

The `id` is again the job ID.


## References

- [Pantheon Documentation](https://docs.pantheon.pegasys.tech/en/latest/)
- [EtherMining Reddit](https://www.reddit.com/r/EtherMining) for community engagement in Ethereum mining.
